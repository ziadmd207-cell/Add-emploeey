<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البطاقة التعريفية الرقمية | الهوية الذكية</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&display=swap');

        :root {
            --primary: #059669;
            /*Emerald Green*/
            --primary-dark: #064e3b;
            --secondary: #10b981;
            --bg: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            direction: rtl;
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* Improved Header */
        .top-nav {
            background: #ffffff;
            height: 75px;
            display: flex;
            align-items: center;
            padding: 0 8%;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            justify-content: center;
        }

        .nav-logo-wrap {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .banner-logo {
            width: 135px;
            height: 135px;
            background: #fff;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            border: 3px solid #ffffff;
            margin-bottom: 20px;
            position: relative;
        }

        .banner-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .banner-logo ion-icon {
            font-size: 60px;
            color: var(--primary);
        }

        .nav-title {
            font-size: 1.25rem;
            font-weight: 900;
            color: #ffffff;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            padding: 10px 24px;
            border-radius: 14px;
            box-shadow: 0 5px 15px rgba(6, 78, 59, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            letter-spacing: -0.2px;
        }

        /* Premium CSS Banner (Trust & Medical Theme) */
        .banner-container {
            width: 100%;
            height: 480px;
            /* Increased height significantly */
            background: linear-gradient(135deg, #065f46 0%, #059669 50%, #10b981 100%);
            position: relative;
            overflow: hidden;
            border-bottom: 5px solid #047857;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 60px;
            /* Room for content above the cut */
        }

        .banner-pattern {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.3;
        }

        .banner-icons {
            position: absolute;
            display: flex;
            gap: 15rem;
            z-index: 1;
            opacity: 0.15;
            pointer-events: none;
        }

        .banner-icons ion-icon {
            font-size: 15rem;
            color: #fff;
        }

        .banner-content {
            position: relative;
            text-align: center;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center perfectly within the taller banner */
        }

        .banner-content ion-icon {
            display: none;
            /* Icon replaced by logo */
        }

        .banner-text {
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
            margin: 0;
            /* Tightened gap */
        }

        .banner-subtext {
            color: #fbbf24;
            font-size: 1.25rem;
            font-weight: 900;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            margin-top: 2px;
            /* Tightened gap */
            background: rgba(0, 0, 0, 0.12);
            padding: 5px 25px;
            border-radius: 50px;
            display: inline-block;
        }

        /* Profile Overlap Layout */
        .profile-wrapper {
            max-width: 500px;
            /* Reduced from 600px to make it more compact */
            margin: -45px auto 4rem;
            /* Lifted up to overlap banner */
            padding: 0 1.5rem;
            position: relative;
            z-index: 10;
        }

        .profile-card {
            background: var(--card-bg);
            border-radius: 40px;
            padding: 3rem 2rem 2.5rem;
            text-align: center;
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.9);
        }

        .user-photo-box {
            width: 160px;
            height: 160px;
            margin: -80px auto 1.5rem;
            /* Still overlapping the card but not the banner */
            position: relative;
        }

        .user-photo-img {
            width: 100%;
            height: 100%;
            border-radius: 60px;
            border: 8px solid #fff;
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
            object-fit: cover;
            background: #f8fafc;
        }

        .status-badge {
            position: absolute;
            bottom: 12px;
            left: 12px;
            width: 28px;
            height: 28px;
            background: #22c55e;
            border: 5px solid #fff;
            border-radius: 50%;
        }

        .emp-name {
            font-size: 1.5rem;
            /* Back to original small scale */
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.3rem;
        }

        .emp-job {
            font-size: 0.9rem;
            /* Compact and clean */
            font-weight: 800;
            color: var(--primary);
            background: #ecfdf5;
            padding: 4px 16px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 1.8rem;
            border: 1px solid #d1fae5;
        }

        /* Detail Cards */
        .details-grid {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .info-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.9rem;
            /* Very compact */
            background: #f8fafc;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .comp-icon-box {
            width: 55px;
            height: 55px;
            background: #fff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            overflow: hidden;
        }

        .comp-icon-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .comp-icon-box ion-icon {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .info-card:hover {
            background: #fff;
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.08);
        }

        .icon-box {
            width: 42px;
            /* Small square icons */
            height: 42px;
            background: #fff;
            color: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
        }

        .info-content {
            text-align: right;
            flex: 1;
        }

        .info-label {
            font-size: 0.75rem;
            /* Smaller labels */
            color: var(--text-muted);
            font-weight: 800;
            margin-bottom: 2px;
        }

        .info-val {
            font-size: 0.95rem;
            /* Compact values */
            font-weight: 800;
            color: var(--text-main);
        }

        .footer-badge {
            margin-top: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 800;
            box-shadow: 0 15px 30px rgba(5, 150, 105, 0.25);
        }

        /* Custom Loading */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loader-circle {
            width: 60px;
            height: 60px;
            border: 6px solid #f1f5f9;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: pulse 1s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
        }

        @media (max-width: 640px) {
            .top-nav {
                height: 80px;
                padding: 0 5%;
            }

            .nav-title {
                font-size: 1.2rem;
            }

            .nav-logo {
                width: 55px;
                height: 55px;
            }

            .emp-name {
                font-size: 1.7rem;
            }

            .user-photo-box {
                width: 140px;
                height: 140px;
                margin-top: -90px;
            }
        }

        /* Footer styles */
        .page-footer {
            margin-top: 4rem;
            padding: 2.5rem 1rem;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            background: #ffffff;
        }

        .footer-brand-text {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            letter-spacing: 0.3px;
        }
    </style>
</head>

<body>

    <div id="loader" class="loader-overlay">
        <div class="loader-circle"></div>
        <p style="margin-top:1.5rem; font-weight:900; color:var(--primary);">جاري تفعيل الهوية الرقمية...</p>
    </div>

    <div id="content" style="display:none;">
        <!-- королевский заголовок (Professional Header) -->
        <header class="top-nav">
            <h1 class="nav-title" id="header-comp-name">اسم الشركة</h1>
        </header>

        <!-- Premium Medical Banner -->
        <div class="banner-container">
            <div class="banner-pattern"></div>
            <div class="banner-icons">
                <ion-icon name="time-outline"></ion-icon>
                <ion-icon name="shield-half-outline"></ion-icon>
            </div>
            <div class="banner-content">
                <div class="banner-logo">
                    <img id="main-logo" src="" style="display:none;">
                    <ion-icon id="main-placeholder" name="business"></ion-icon>
                </div>

                <h2 class="banner-text">الخدمات التأمينية الطبية</h2>
                <p class="banner-subtext">بسرعة.. وثقة.. وأمان</p>
            </div>
        </div>

        <!-- Professional Identity Card -->
        <div class="profile-wrapper">
            <div class="profile-card">
                <div class="user-photo-box">
                    <img id="user-photo" class="user-photo-img" src="">
                    <div class="status-badge"></div>
                </div>

                <h1 class="emp-name" id="user-name"></h1>
                <p class="emp-job" id="user-job"></p>

                <div class="details-grid">
                    <div class="info-card">
                        <div class="icon-box"><ion-icon name="finger-print-outline"></ion-icon></div>
                        <div class="info-content">
                            <p class="info-label">الرقم القومي</p>
                            <p class="info-val" id="user-nid"></p>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="icon-box"><ion-icon name="business-outline"></ion-icon></div>
                        <div class="info-content">
                            <p class="info-label">اسم الشركة</p>
                            <p class="info-val" id="user-comp"></p>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="icon-box"><ion-icon name="briefcase-outline"></ion-icon></div>
                        <div class="info-content">
                            <p class="info-label">المسمى الوظيفي</p>
                            <p class="info-val" id="user-job-detail"></p>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.2rem;">
                        <div class="info-card" style="padding: 1.2rem;">
                            <div class="info-content">
                                <p class="info-label">تاريخ التسجيل</p>
                                <p class="info-val" id="user-start" style="font-size:1rem;"></p>
                            </div>
                        </div>
                        <div class="info-card" style="padding: 1.2rem; border-right: 4px solid var(--primary);">
                            <div class="info-content">
                                <p class="info-label">تاريخ الانتهاء</p>
                                <p class="info-val" id="user-end" style="font-size:1rem;"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="footer-badge">
                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                    هوية رسمية مسجلة وفعالة
                </div>
            </div>

            <p style="text-align:center; margin-top:3rem; color:var(--text-muted); font-size:0.8rem; font-weight:800;">
            </p>
        </div>

        <footer class="page-footer">
            <p class="footer-brand-text">Healthy Care A member of MH Group</p>
        </footer>
    </div>
    </div>

    <script>
        const SUPA_URL = "https://cioydgupnzyckmoklgsf.supabase.co";
        const SUPA_KEY = "sb_publishable_jbXpMOZBz1zEy-QkD720tQ_EJxzOwev";
        const db = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        window.onload = async () => {
            const slug = new URLSearchParams(window.location.search).get('id');


            if (!slug) {
                document.getElementById('loader').innerHTML = '<p style="color:#ef4444; font-weight:900;">خطأ: الرابط غير صالح.</p>';
                return;
            }

            try {
                const [uRes, cRes] = await Promise.all([
                    db.from('users').select('*').eq('slug', slug).single(),
                    db.from('company_settings').select('*').limit(1).single()
                ]);

                if (uRes.error || !uRes.data) {
                    document.getElementById('loader').innerHTML = '<p style="color:#ef4444; font-weight:900;">هذا الموظف غير مسجل.</p>';
                    return;
                }

                const user = uRes.data;
                const company = cRes.data;

                // Sync UI
                if (company) {
                    document.getElementById('header-comp-name').innerText = company.company_name;
                    if (company.company_logo_url) {
                        const img = document.getElementById('main-logo');
                        img.src = company.company_logo_url;
                        img.style.display = 'block';
                        document.getElementById('main-placeholder').style.display = 'none';
                    }
                }

                // Fill Identity Card
                document.getElementById('user-name').innerText = `${user.first_name} ${user.last_name}`;
                document.getElementById('user-job').innerText = user.job_title;
                document.getElementById('user-job-detail').innerText = user.job_title;
                document.getElementById('user-nid').innerText = user.national_id;
                document.getElementById('user-comp').innerText = user.company_name || (company ? company.company_name : 'غير مسجل');
                document.getElementById('user-start').innerText = user.start_date || 'غير محدد';
                document.getElementById('user-end').innerText = user.end_date || 'غير محدد';
                document.getElementById('user-photo').src = user.photo_url || 'https://via.placeholder.com/200';

                document.getElementById('loader').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (err) {
                document.getElementById('loader').innerHTML = '<p style="color:#ef4444; font-weight:900;">فشل الاتصال بقاعدة البيانات.</p>';
            }
        };
    </script>
</body>

</html>
