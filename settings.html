<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إعدادات الشركة | لوحة التحكم</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-logo" id="s-logo">
                    <ion-icon name="business" style="color:#4f46e5; font-size:50px;"></ion-icon>
                </div>
                <h2 id="s-name">الشركة</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html">
                    <ion-icon name="person-add-outline"></ion-icon>
                    <span>إضافة موظف</span>
                </a>
                <a href="employees.html">
                    <ion-icon name="people-outline"></ion-icon>
                    <span>عرض الموظفين</span>
                </a>
                <a href="settings.html" class="active">
                    <ion-icon name="settings-outline"></ion-icon>
                    <span>إعدادات الشركة</span>
                </a>
                <a href="admin-security.html">
                    <ion-icon name="lock-closed-outline"></ion-icon>
                    <span>أمان الحساب</span>
                </a>
                <a href="#" onclick="logout()" style="margin-top: auto; color: #ef4444;">
                    <ion-icon name="log-out-outline"></ion-icon>
                    <span>تسجيل الخروج</span>
                </a>
            </nav>
        </aside>

        <main class="page-main">
            <div class="header-banner">
                <ion-icon name="settings"></ion-icon>
                <div>
                    <h1>إعدادات الشركة</h1>
                    <p>تعديل اسم الشركة وشعارها الرسمي في النظام</p>
                </div>
            </div>

            <form id="settings-form" class="card">
                <div class="field">
                    <label>اسم الشركة الرسمي</label>
                    <input type="text" id="company-name" class="input" required
                        placeholder="شركة التميز للحلول التقنية">
                </div>

                <div class="field">
                    <label>شعار الشركة (Logo)</label>
                    <div class="logo-area">
                        <div class="logo-box" id="logo-preview">
                            <ion-icon name="image-outline" style="font-size:40px; color:#cbd5e1;"></ion-icon>
                        </div>
                        <div>
                            <label class="btn btn-dark" style="cursor:pointer;">
                                <ion-icon name="cloud-upload-outline"></ion-icon> تغيير اللوجو
                                <input type="file" id="logo-file" hidden accept="image/*">
                            </label>
                            <p style="font-size:0.8rem; color:var(--muted); font-weight:600; margin-top:8px;">حد أقصى 1
                                ميجا - PNG / JPG / JPEG</p>
                        </div>
                    </div>
                </div>

                <div id="status-msg"
                    style="display:none; padding:1rem; border-radius:12px; font-weight:800; text-align:center; margin-top:1rem;">
                </div>

                <button type="submit" id="save-btn" class="btn btn-primary btn-w100" style="margin-top:2rem;">
                    <ion-icon name="save-outline"></ion-icon> حفظ جميع الإعدادات
                </button>
            </form>
        </main>
    </div>

    <!-- Success Popup -->
    <div class="success-overlay" id="success-overlay">
        <div class="success-box">
            <div class="success-check">
                <ion-icon name="checkmark-sharp"></ion-icon>
            </div>
            <h2>تم التحديث بنجاح!</h2>
            <p>تم حفظ التغييرات وتعميمها على جميع صفحات الموقع</p>
            <button onclick="document.getElementById('success-overlay').classList.remove('show')"
                class="btn btn-primary btn-w100">
                <ion-icon name="checkmark-circle-outline"></ion-icon> ممتاز
            </button>
        </div>
    </div>

    <script>
        const SUPA_URL = "https://cioydgupnzyckmoklgsf.supabase.co";
        const SUPA_KEY = "sb_publishable_jbXpMOZBz1zEy-QkD720tQ_EJxzOwev";
        const db = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        let pendingLogo = null;

        // Function to compress image
        async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        window.addEventListener('load', async () => {
            await loadCurrentSettings();

            document.getElementById('logo-file').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Quality Check
                if (file.size > 1.1 * 1024 * 1024) {
                    alert('⚠️ تنبيه: حجم الشعار كبير. سيقوم النظام بضغطه تلقائياً لتسريع التحميل والتصفح.');
                }

                pendingLogo = await compressImage(file);
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById('logo-preview').innerHTML = `<img src="${ev.target.result}">`;
                };
                reader.readAsDataURL(pendingLogo);
            };

            document.getElementById('settings-form').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-btn');
                const statusDiv = document.getElementById('status-msg');
                btn.disabled = true;
                btn.textContent = 'جاري الضغط والحفظ...';

                try {
                    let logoUrl = null;
                    if (pendingLogo) {
                        const fName = `logo-${Date.now()}.jpg`;
                        // Upload to company-logos bucket as requested
                        const { error: upErr } = await db.storage.from('company-logos').upload(fName, pendingLogo);
                        if (upErr) throw upErr;
                        logoUrl = db.storage.from('company-logos').getPublicUrl(fName).data.publicUrl;
                    }

                    const newName = document.getElementById('company-name').value.trim();
                    const saveData = { company_name: newName };
                    if (logoUrl) saveData.company_logo_url = logoUrl;

                    // Fetch current row to know WHAT to update
                    const { data: rows } = await db.from('company_settings').select('*').limit(1);

                    let result;
                    if (rows && rows.length > 0) {
                        // Update existing row
                        result = await db.from('company_settings')
                            .update(saveData)
                            .or(`company_name.eq."${rows[0].company_name}",company_name.is.null`);
                    } else {
                        // Insert if completely empty
                        result = await db.from('company_settings').insert([saveData]);
                    }

                    if (result.error) throw result.error;

                    document.getElementById('s-name').innerText = newName;
                    if (logoUrl) document.getElementById('s-logo').innerHTML = `<img src="${logoUrl}">`;

                    document.getElementById('success-overlay').classList.add('show');
                    pendingLogo = null;

                } catch (err) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#fef2f2';
                    statusDiv.style.color = '#dc2626';
                    statusDiv.textContent = '❌ خطأ: ' + err.message;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<ion-icon name="save-outline"></ion-icon> حفظ جميع الإعدادات';
                }
            };
        });

        async function loadCurrentSettings() {
            try {
                const { data } = await db.from('company_settings').select('*').limit(1).single();
                if (data) {
                    document.getElementById('company-name').value = data.company_name || '';
                    document.getElementById('s-name').innerText = data.company_name || 'الشركة';
                    if (data.company_logo_url) {
                        document.getElementById('logo-preview').innerHTML = `<img src="${data.company_logo_url}">`;
                        document.getElementById('s-logo').innerHTML = `<img src="${data.company_logo_url}">`;
                    }
                }
            } catch (e) { console.log('load error', e); }
        }
    </script>
</body>

</html>