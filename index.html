<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة موظف | لوحة التحكم</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-logo" id="s-logo">
                    <ion-icon name="business" style="color:#4f46e5; font-size:50px;"></ion-icon>
                </div>
                <h2 id="s-name">الشركة</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="active">
                    <ion-icon name="person-add-outline"></ion-icon>
                    <span>إضافة موظف</span>
                </a>
                <a href="employees.html">
                    <ion-icon name="people-outline"></ion-icon>
                    <span>عرض الموظفين</span>
                </a>
                <a href="settings.html">
                    <ion-icon name="settings-outline"></ion-icon>
                    <span>إعدادات الشركة</span>
                </a>
                <a href="admin-security.html">
                    <ion-icon name="lock-closed-outline"></ion-icon>
                    <span>أمان الحساب</span>
                </a>
                <a href="#" onclick="logout()" style="margin-top: auto; color: #ef4444;">
                    <ion-icon name="log-out-outline"></ion-icon>
                    <span>تسجيل الخروج</span>
                </a>
            </nav>
        </aside>

        <main class="page-main">
            <div class="header-banner">
                <ion-icon name="person-add"></ion-icon>
                <div>
                    <h1>إضافة موظف</h1>
                    <p>أدخل بيانات الموظف وسيتم توليد بطاقة الهوية وكود QR تلقائياً</p>
                </div>
            </div>

            <form id="add-form" class="card">
                <div class="photo-section">
                    <div class="photo-thumb" onclick="document.getElementById('photo-file').click()">
                        <img id="photo-preview" style="display:none;">
                        <ion-icon id="cam-icon" name="camera-outline" style="font-size:30px; color:#94a3b8;"></ion-icon>
                    </div>
                    <div class="photo-text">
                        <h4>الصورة الشخصية</h4>
                        <p id="photo-limit-label">اضغط لاختيار صورة - حد أقصى 1 ميجا</p>
                    </div>
                    <input type="file" id="photo-file" hidden accept="image/*">
                </div>

                <div class="two-cols">
                    <div class="field">
                        <label>الاسم الأول</label>
                        <input type="text" id="fname" class="input" required placeholder="يوسف">
                    </div>
                    <div class="field">
                        <label>اسم العائلة</label>
                        <input type="text" id="lname" class="input" required placeholder="المنصور">
                    </div>
                </div>

                <div class="field">
                    <label>الرقم القومي</label>
                    <input type="text" id="nid" class="input" required placeholder="00000000000000">
                </div>

                <div class="two-cols">
                    <div class="field">
                        <label>المسمى الوظيفي</label>
                        <input type="text" id="job" class="input" required placeholder="مدير المبيعات">
                    </div>
                    <div class="field">
                        <label>اسم الشركة</label>
                        <input type="text" id="comp" class="input">
                    </div>
                </div>

                <div class="two-cols">
                    <div class="field">
                        <label>تاريخ التسجيل</label>
                        <input type="date" id="sdate" class="input">
                    </div>
                    <div class="field">
                        <label>تاريخ الانتهاء</label>
                        <input type="date" id="edate" class="input">
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="btn btn-primary btn-w100" style="margin-top:0.5rem;">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    حفظ البيانات وتوليد الكود
                </button>
            </form>
        </main>
    </div>

    <div class="success-overlay" id="success-overlay">
        <div class="success-box">
            <div class="success-check">
                <ion-icon name="checkmark-sharp"></ion-icon>
            </div>
            <h2>تم الحفظ بنجاح!</h2>
            <p>تم إنشاء هوية الموظف وتوليد كود QR بنجاح</p>
            <div id="qr-area" class="qr-holder"></div>
            <div class="two-cols" style="gap:0.8rem; margin-top:1rem;">
                <button onclick="downloadQR()" class="btn btn-primary">
                    <ion-icon name="download-outline"></ion-icon> تحميل QR
                </button>
                <a id="profile-link" href="#" target="_blank" class="btn btn-light">
                    <ion-icon name="eye-outline"></ion-icon> معاينة الصفحة
                </a>
            </div>
            <button onclick="closeSuccess()" class="btn btn-light btn-w100" style="margin-top:1rem;">
                <ion-icon name="add-circle-outline"></ion-icon> إضافة موظف جديد
            </button>
        </div>
    </div>

    <script>
        const SUPA_URL = "https://cioydgupnzyckmoklgsf.supabase.co";
        const SUPA_KEY = "sb_publishable_jbXpMOZBz1zEy-QkD720tQ_EJxzOwev";
        const db = window.supabase.createClient(SUPA_URL, SUPA_KEY);

        let photoFile = null;

        // Function to compress image
        async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        window.addEventListener('load', async () => {
            try {
                const { data } = await db.from('company_settings').select('*').limit(1).single();
                if (data) {
                    document.getElementById('s-name').innerText = data.company_name || 'الشركة';
                    if (data.company_logo_url) {
                        document.getElementById('s-logo').innerHTML = '<img src="' + data.company_logo_url + '">';
                    }
                    const c = document.getElementById('comp');
                    if (c && !c.value) c.value = data.company_name || '';
                }
            } catch (e) { console.log('branding load', e); }

            document.getElementById('photo-file').addEventListener('change', async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                // 1MB Limit Guard
                if (file.size > 1.1 * 1024 * 1024) {
                    alert('⚠️ تنبيه: حجم الصورة المحملة أكبر من 1 ميجا. سيتم ضغط الصورة تلقائياً للحفاظ على الأداء، ولكن يفضل اختيار ملفات أصغر مستقبلاً.');
                }

                // Show loading state for preview if needed
                photoFile = await compressImage(file);

                const reader = new FileReader();
                reader.onload = function (ev) {
                    const img = document.getElementById('photo-preview');
                    img.src = ev.target.result;
                    img.style.display = 'block';
                    document.getElementById('cam-icon').style.display = 'none';
                };
                reader.readAsDataURL(photoFile);
            });

            document.getElementById('add-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const btn = document.getElementById('submit-btn');
                btn.disabled = true;
                btn.textContent = 'جاري الضغط والحفظ...';

                try {
                    let photoUrl = '';

                    if (photoFile) {
                        const fName = 'user-' + Date.now() + '.jpg';
                        // Upload to user-photos bucket
                        const { error: upErr } = await db.storage.from('user-photos').upload(fName, photoFile);
                        if (upErr) throw upErr;
                        photoUrl = db.storage.from('user-photos').getPublicUrl(fName).data.publicUrl;
                    }

                    const slug = btoa(Date.now().toString() + Math.random().toString(36))
                        .replace(/[^a-zA-Z0-9]/g, '')
                        .substring(0, 12);

                    const payload = {
                        first_name: document.getElementById('fname').value.trim(),
                        last_name: document.getElementById('lname').value.trim(),
                        national_id: document.getElementById('nid').value.trim(),
                        job_title: document.getElementById('job').value.trim(),
                        company_name: document.getElementById('comp').value.trim(),
                        start_date: document.getElementById('sdate').value || null,
                        end_date: document.getElementById('edate').value || null,
                        slug: slug,
                        photo_url: photoUrl
                    };

                    const { error } = await db.from('users').insert([payload]);
                    if (error) throw error;

                    showSuccess(slug);
                    document.getElementById('add-form').reset();
                    document.getElementById('photo-preview').style.display = 'none';
                    document.getElementById('cam-icon').style.display = '';
                    photoFile = null;

                } catch (err) {
                    alert('خطأ أثناء الحفظ: ' + (err.message || JSON.stringify(err)));
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<ion-icon name="checkmark-circle"></ion-icon> حفظ البيانات وتوليد الكود';
                }
            });
        });

        function showSuccess(slug) {
            const overlay = document.getElementById('success-overlay');
            const qrDiv = document.getElementById('qr-area');
            qrDiv.innerHTML = '';
            new QRCode(qrDiv, {
                text: window.location.origin + '/profile.html?id=' + slug,
                width: 150, height: 150
            });
            document.getElementById('profile-link').href = 'profile.html?id=' + slug;
            overlay.classList.add('show');
        }

        function closeSuccess() {
            document.getElementById('success-overlay').classList.remove('show');
        }

        function downloadQR() {
            const img = document.querySelector('#qr-area img');
            if (img) {
                const a = document.createElement('a');
                a.download = 'QR_Identity.png';
                a.href = img.src;
                a.click();
            }
        }
    </script>
</body>

</html>